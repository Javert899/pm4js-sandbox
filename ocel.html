<html>
	<head>
		<link rel="stylesheet" href="ocel.css">
		<script src="scripts/pm4js/eventLog.js"></script>
		<script src="scripts/generic/jquery.min.js"></script>
		<script src="scripts/generic/download-utility.js"></script>
		<script src="scripts/generic/plotly-2.1.0.min.js"></script>
		<script src="scripts/generic/sweetalert2.all.min.js"></script>
		<script src="scripts/generic/bootstrap.min.js"></script>
		<script src="scripts/generic/navigation.min.js"></script>
		<script src="scripts/generic/fontawesome-all.min.js"></script>
		<script src="scripts/pm4js_latest.js"></script>
		<script src="scripts/generic/mxClient.min.js"></script>
		<script src="scripts/ocel/eventsView.js"></script>
		<script src="scripts/ocel/objectsView.js"></script>
		<script src="scripts/ocel/edgesView.js"></script>
		<script src="scripts/ocel/ocdfg-model.js"></script>
		<script src="scripts/ocel/ocdfg-visualization.js"></script>
		<script src="scripts/ocel/xmlocel-exporter.js"></script>
		<script src="scripts/ocel/xmlocel-importer.js"></script>
		<script src="scripts/ocel/jsonocel-exporter.js"></script>
		<script src="scripts/ocel/jsonocel-importer.js"></script>
		<script src="scripts/ocel/ocel-flattening.js"></script>
		<script src="scripts/generic/sorttable.js"></script>
		<script src="scripts/ocel/eventsList.js"></script>
		<script src="scripts/ocel/objectsList.js"></script>
		<script src="scripts/ocel/plotly-graphs.js"></script>
		<link rel="stylesheet" href="static/bootstrap.min.css"></link>
		<link rel="stylesheet" href="static/bootstrap-grid.min.css"></link>
		<link rel="stylesheet" href="static/bootstrap-reboot.min.css"></link>
		<link rel="stylesheet" href="static/navx-navigation.min.css"></link>
		<link rel="stylesheet" href="static/navx-styles.css"></link>
		<link rel="stylesheet" href="static/fontawesome-all.min.css"></link>
	</head>
	<body>
		<script type="text/javascript">
			let selectedActivity = null;
			let selectedOt = null;
			let selectedEdge = null;
			let visualization = null;
			//let eventLog = null;
		</script>
		<div id="uploadPart" style="display: ">
			<img src="static/pads_rwth.png" /><br />
			<h3>OC-DFG visualization</h3>
			Welcome! Please upload an object-centric event log in the OCEL-XML and/or the OCEL-JSON formats.
			<div id="initial_upload" style="display: ">
				<input type="file" id="upload" />
			</div>
		</div>
		<div id="mainApplication" style="display: none" class="container-fluid">
			<div id="header" style="background-color:" class="border-bottom">
				<nav id="navigationHeader" class="navigation navigation-justified" style="background-image: url('static/top-background.png'); background-size:100% 100%;">
					<div class="navigation-header">

					</div>
					<div class="navigation-body">		
						<ul class="navigation-menu">

							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showProcessModelPage()"><i class="fas fa-project-diagram"></i>&nbsp;Process Schema</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showEventsList()"><i class="fas fa-atom"></i>Events</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showObjectsList()"><i class="fas fa-database"></i>&nbsp;Objects</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showGraphs()"><i class="fas fa-chart-pie"></i>&nbsp;Statistics</a>
							</li>
						
							<li class="navigation-item">
								<a class="navigation-link" href="#"><i class="fas fa-download"></i>&nbsp;Download Log</a>
								<div class="navigation-megamenu">
									<div class="navigation-megamenu-container">
										<div class="navigation-row">
											<div><button id="downloadJsonOcel" onclick="downloadJsonOcel()" class="btn btn-primary">Download JSON Ocel</button>&nbsp;</div>
											<div><button id="downloadXmlOcel" onclick="downloadXmlOcel()" class="btn btn-primary">Download XML Ocel</button>&nbsp;</div>
											<div>
												Flattening OT: <select id="flatteningOt" class="form-select">
												</select>
												<button id="flattenEventLog" onclick="flattenEventLog()" class="btn btn-primary">Flatten (XES)&nbsp;</button>
											</div>
										</div>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</nav>
			</div>
			<div id="processModelPage" style="display:; overflow: hidden">
				<div class="row" style="height: 85%">
					<!-- style="background-image: url('static/left-background.png'); background-size:100% 100%;"-->
					<div class="col-2 align-self-center text-center">
						<div class="panel panel-default">
							<div class="panel-heading"><h4>Statistics</h4></div>
							<div class="panel-body">
								<div>N. Events:</div>
								<div id="numEvents" style="font-family: geneva; font-weight: bold; font-size: 18pt">0</div>
								<div>N. Unique Objects:</div>
								<div id="numUniqObjects" style="font-family: geneva; font-weight: bold; font-size: 18pt">0</div>
								<div>N. Total Objects:</div>
								<div id="numTotalObjects" style="font-family: geneva; font-weight: bold; font-size: 18pt">0</div>
							</div>
						</div>
						<div>&nbsp;</div>
						<div class="panel panel-default">
							<div class="panel-heading"><h4>Sliders</h4></div>
							<div class="panel-body">
								<div>% of Activities:</div>
								<div><input id="af_slider" type="range" min="0" max="100" value="70" class="slider form-range"></div>
								<div>% of Paths:</div>
								<div><input id="pf_slider" type="range" min="0" max="100" value="70" class="slider form-range"></div>
								<div>&nbsp;</div>
								<div><button id="apply_changes" onclick="doVisualization()" class="btn btn-primary">Apply Changes</button></div>
							</div>
						</div>
					</div>
					<div class="col-10 border-left">
						<div id="graphContainerHeader">
							<nav id="navigationGraph" class="navigation navigation-justified border-bottom">
								<div class="navigation-header">

								</div>
								<div class="navigation-body">		
									<ul class="navigation-menu">

										<li class="navigation-item">
											<a class="navigation-link" href="#"><i class="fas fa-cog"></i>&nbsp;Options</a>
											<div class="navigation-megamenu">
												<div class="navigation-megamenu-container">
													<div class="navigation-row">
														<div>Visualization:
														<select id="visualizationType" class="form-select">
															<option value="dfg" selected>DFG</option>
															<option value="petriNet">Petri Net</option>
														</select></div>
														<div>Annotation:
														<select id="annotationSelector" class="form-select">
															<option id="events" value="0">Events</option>
															<option id="unique_objects" value="1" selected>Unique Objects</option>
															<option id="total_objects" value="2">Total Objects</option>
														</select></div>
														<div><button id="apply_changes2" onclick="doVisualization()" class="btn btn-primary">Apply Changes</button></div>
													</div>
												</div>
											</div>
										</li>
									
										<li class="navigation-item">
											<a class="navigation-link" href="#"><i class="fab fa-superpowers"></i>Object Types</a>
											<div class="navigation-megamenu">
												<div class="navigation-megamenu-container">
													<div class="navigation-row">
														<div>
														Select the object types: <select id="objectTypes" multiple style="height: 40px" class="form-select">
														</select></div>
														<div>
														<button id="filterObjectTypes" onclick="filterObjectTypes()" class="btn btn-primary">Filter on Obj Types</button></div>
														<div></div>
													</div>
												</div>
											</div>
										</li>
										
										<li class="navigation-item">
											<a class="navigation-link" href="#"><i class="fas fa-filter"></i>&nbsp;Filters</a>
											<div class="navigation-megamenu">
												<div class="navigation-megamenu-container">
													<div class="navigation-row">
														<button id="reset_filters" onclick="resetFilters()" class="btn btn-primary">Reset Filters</button>
													</div>
												</div>
											</div>
										</li>
										
									</ul>
								</div>
							</nav>
						</div>
						<div id="graphContainer"></div>
					</div>
					<ul id="menu" style="display: none">
					</ul>
				</div>
				<script type="text/javascript">
					var navigationGraph = null;
					
					function doVisualization() {
						let af = document.getElementById("af_slider").value / 100.0;
						let pf = document.getElementById("pf_slider").value / 100.0;
						let annotation = parseInt(document.getElementById("annotationSelector").value);
						visualization.ACTIVITY_FREQUENCY = af;
						visualization.PATHS_FREQUENCY = pf;
						visualization.IDX = annotation;
						visualization.displayType = document.getElementById("visualizationType").value;
						visualization.represent();
						if (navigationGraph == null) {
							navigationGraph = new Navigation(document.getElementById("navigationGraph"));
						}
					}
					
					function resetFilters() {
						visualization.resetFilters();
						doVisualization();
					}
					
					function downloadJsonOcel() {
						let jsonStri = JsonOcelExporter.exportLog(visualization.model.ocel);
						download(jsonStri, "obj-centr-log.jsonocel", "text/json");
					}
					
					function downloadXmlOcel() {
						let xmlStri = XmlOcelExporter.exportLog(visualization.model.ocel);
						download(xmlStri, "obj-centr-log.xmlocel", "text/xml");
					}
					
					function flattenEventLog() {
						let ot = document.getElementById("flatteningOt").value;
						let eventLog = OcelFlattening.flatten(visualization.model.ocel, ot);
						let xmlStri = XesExporter.apply(eventLog);
						download(xmlStri, "flattened.xes", "text/xml");
					}
					
					function filterObjectTypes() {
						let selectedOptions = [];
						for (let option of document.getElementById("objectTypes").children) {
							if (option.selected) {
								selectedOptions.push(option.value);
							}
						}
						let filteredModel = visualization.model.filterObjectTypes(selectedOptions);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterRelatedObjectsActivity() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let filteredModel = visualization.model.filterRelatedObjects(relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonRelatedObjectsActivity() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !relObj.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function expandActivity() {
						visualization.doExpandActivity(selectedActivity);
						visualization.represent();
					}
					
					function filterNonStartingWith() {
						let startingWith = visualization.model.otObjectsView[selectedOt].getStartingWith(selectedActivity);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !startingWith.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, startingWith);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonEndingWith() {
						let endingWith = visualization.model.otObjectsView[selectedOt].getEndingWith(selectedActivity);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !endingWith.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, endingWith);
						visualization.setFilteredModel(filteredModel);
					}
					
					function seeRelatedObjAct() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let stru = relObj.toString();
						if (stru.length > 1000) {
							stru = stru.substring(0, 999) + "...";
						}
						Swal.fire({title: "Related Objects", confirmButton: "ok", html: stru});
					}
					
					function filterRelatedObjectsEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let filteredModel = visualization.model.filterRelatedObjects(relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonRelatedObjectsEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedEdge[2]].objectsIds);
						let difference = allObjOt.filter(x => !relObj.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function seeRelatedObjEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let stru = relObj.toString();
						if (stru.length > 1000) {
							stru = stru.substring(0, 999) + "...";
						}
						Swal.fire({title: "Related Objects", confirmButton: "ok", html: stru});
					}
					
					function callbackActivity(activity, ot) {
						selectedActivity = activity;
						selectedOt = ot;
					}
					
					function callbackEdge(edge) {
						selectedEdge = edge;
					}
					
					function callbackStatistics(events, uo, to) {
						document.getElementById("numEvents").innerHTML = events;
						document.getElementById("numUniqObjects").innerHTML = uo;
						document.getElementById("numTotalObjects").innerHTML = to;
					}
					
					function handleFileSelect(evt) {
						var files = evt.target.files; // FileList object
						// use the 1st file from the list
						f = files[0];
						var reader = new FileReader();
						reader.onload = function(e) {
							console.log(f);
							let contentStri = e.target.result;
							if (f.name.endsWith(".xmlocel")) {
								eventLog = XmlOcelImporter.importLog(contentStri);
								createVisualization();
							}
							else {
								eventLog = JsonOcelImporter.importLog(contentStri);
								createVisualization();
							}
						}
						reader.readAsText(f);
					}
					
					function createVisualization() {
						document.getElementById("mainApplication").style.display = "";
						document.getElementById("uploadPart").style.display = "none";
						visualization = new OcdfgVisualization(new OcdfgModel(eventLog), "graphContainer");
						visualization.callbackActivity = callbackActivity;
						visualization.callbackEdge = callbackEdge;
						visualization.callbackStatistics = callbackStatistics;
						visualization.populateStatistics();
						doVisualization();
					}
					
					document.getElementById('upload').addEventListener('change', handleFileSelect, false);
				</script>
			</div>
			<div id="eventsListPage" style="display: none">
				<p>The page shows the list of events of the log. Each event is distinguished by its fundamental properties (ID, activity and timestamp),
				a list of related objects for each type, and values for some attributes. Clicking an object, it is possible to see the lifecycle
				of the object.</p>
				<table id="eventsListTable" border="1"  class="table">
				</table>
			</div>
			<div id="objectsListPage" style="display: none">
				<p>The page shows the properties of the objects, after the selection of an object type. Each object is distinguished by the timestamp of the first
				event of its lifecycle, the timestamp of the last event of its lifecycle, and the difference between them.</p>
				<p>To start, please select an object type:
				<select id="otObjListSelection" class="form-select">
				</select>
				<button id="showObjListOt" onclick="showObjListOt()" class="btn btn-primary">Show the list of Objects</button>
				</p>
				<div style="height: 80%; overflow-y: scroll">
					<table id="objectsListTable" border="1" class="table">
					</table>
				</div>
			</div>
			<div id="plotlyGraphsPage" style="display: none">
				<div class="row" style="height: 85%">
					<!--align-self-center text-center-->
					<div class="col-2 border-right">
						<h6>Select the statistic:</h6>
						<div><i class="fas fa-chart-pie"></i>&nbsp;<a href="javascript:showSpecificGraph('plotlyOtGraph')">Objects per Type</a></div>
						<div><i class="fas fa-chart-bar"></i>&nbsp;<a href="javascript:showSpecificGraph('plotlyActGraph')">Events per Activity</a></div>
						<div><i class="fas fa-chart-bar"></i>&nbsp;<a href="javascript:showSpecificGraph('plotlyObjPerEveGraph')">N. Objects per Event</a></div>
						<div><i class="fas fa-chart-bar"></i>&nbsp;<a href="javascript:showSpecificGraph('plotlyLifecycleLengthGraph')">Length of Object Lifecycle</a></div>				
						<div><i class="fas fa-box"></i>&nbsp;<a href="javascript:showSpecificGraph('plotlyLifecycleDurationGraph')">Lifecycle Duration (logarithmic)</a></div>
					</div>
					<div class="col-10">
						<div id="plotlyOtGraph" style="width: 100%; height: 100%; display: none">
							
						</div>
						<div id="plotlyActGraph" style="width: 100%; height: 100%; display: none">
							
						</div>
						<div id="plotlyObjPerEveGraph" style="width: 100%; height: 100%; display: none">
							
						</div>
						<div id="plotlyLifecycleLengthGraph" style="width: 100%; height: 100%; display: none">
							
						</div>
						<div id="plotlyLifecycleDurationGraph" style="width: 100%; height: 100%; display: none">
							
						</div>
					</div>
				</div>
			</div>
			<div class="hover_bkgr_fricc">
				<span class="helper"></span>
				<div>
					<div class="popupCloseButton">&times;</div>
					<h4><b>Lifecycle of the Object:</b> <span id="popupObjId"></h4>
					<div style="width: 100%; height: 85%; overflow: scroll">
						<table id="customEventsListTable" border="1">
						</table>
					</div>
				</div>
			</div>
		</div>
		<script src="logs/example-jsonocel.js"></script>
		<script type="text/javascript">
			function hideAllDivsPages() {
				document.getElementById("processModelPage").style.display = "none";
				document.getElementById("eventsListPage").style.display = "none";
				document.getElementById("objectsListPage").style.display = "none";
				document.getElementById("plotlyGraphsPage").style.display = "none";
			}
			
			function showProcessModelPage() {
				hideAllDivsPages();
				document.getElementById("processModelPage").style.display = "";
			}
			
			function showEventsList() {
				hideAllDivsPages();
				document.getElementById("eventsListPage").style.display = "";
				eventsListFactory = new EventsListFactory(visualization.model);
				eventsListFactory.buildEventsTable(document.getElementById("eventsListTable"));
			}
			
			function showObjectsList() {
				hideAllDivsPages();
				document.getElementById("objectsListPage").style.display = "";
			}
			
			function showGraphs() {
				hideAllDivsPages();
				document.getElementById("plotlyGraphsPage").style.display = "";
				plotlyOcelGraphs = new PlotlyOcelGraphs(visualization.model);
				showSpecificGraph("plotlyOtGraph");
			}
			
			function showSpecificGraph(divName) {
				document.getElementById("plotlyOtGraph").style.display = "none";
				document.getElementById("plotlyActGraph").style.display = "none";
				document.getElementById("plotlyObjPerEveGraph").style.display = "none";
				document.getElementById("plotlyLifecycleLengthGraph").style.display = "none";
				document.getElementById("plotlyLifecycleDurationGraph").style.display = "none";

				document.getElementById(divName).style.display = "";
				if (divName == "plotlyOtGraph") {
					plotlyOcelGraphs.buildOtGraph();
				}
				else if (divName == "plotlyActGraph") {
					plotlyOcelGraphs.buildActivitiesGraph();
				}
				else if (divName == "plotlyObjPerEveGraph") {
					plotlyOcelGraphs.buildObjectsPerEventGraph();
				}
				else if (divName == "plotlyLifecycleLengthGraph") {
					plotlyOcelGraphs.buildLifecycleLength();
				}
				else if (divName == "plotlyLifecycleDurationGraph") {
					plotlyOcelGraphs.buildObjectDuration();
				}
			}
			
			function clickedObjectInEveTable(obj) {
				let relTuples = visualization.model.overallObjectsView.objectsIdsSorted[obj];
				let relEvs = {};
				for (let tup of relTuples) {
					relEvs[tup[0]] = 0;
				}
				let eventsListFactory = new EventsListFactory(visualization.model);
				eventsListFactory.buildEventsTable(document.getElementById("customEventsListTable"), events=relEvs, enable_click=false, target_obj=obj);
				$('.hover_bkgr_fricc').show();
				document.getElementById("popupObjId").innerHTML = obj;
			}
			
			function showObjListOt() {
				let selectedOt = document.getElementById("otObjListSelection").value;
				objectsListFactory = new ObjectsListFactory(visualization.model);
				objectsListFactory.buildObjectsTable(document.getElementById("objectsListTable"), selectedOt);
			}

			$('.hover_bkgr_fricc').click(function(){
				$('.hover_bkgr_fricc').hide();
			});
			$('.popupCloseButton').click(function(){
				$('.hover_bkgr_fricc').hide();
			});
			
			createVisualization();
		</script>
		<script type="text/javascript">
const menu = document.querySelector('#menu');
// hide the menu
//window.addEventListener('click', event => menu.style.display = 'none')
// show the menu when right-clicked
window.addEventListener('contextmenu', event => {
  event.preventDefault()
  menu.style.setProperty('--mouse-x', event.clientX + 'px')
  menu.style.setProperty('--mouse-y', event.clientY + 'px')
  menu.style.display = 'block'
});

			var navigationHeader = new Navigation(document.getElementById("navigationHeader"));
		</script>
	</body>
</html>