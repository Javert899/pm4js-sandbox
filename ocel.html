<html>
	<head>
		<link rel="stylesheet" href="ocel.css">
		<script src="scripts/pm4js/eventLog.js"></script>
		<script src="scripts/generic/jquery.min.js"></script>
		<script src="scripts/generic/download-utility.js"></script>
		<script src="scripts/generic/plotly-2.1.0.min.js"></script>
		<script src="scripts/generic/sweetalert2.all.min.js"></script>
		<script src="scripts/generic/bootstrap.min.js"></script>
		<script src="scripts/generic/navigation.min.js"></script>
		<script src="scripts/generic/fontawesome-all.min.js"></script>
		<script src="scripts/pm4js_latest.js"></script>
		<script src="scripts/generic/mxClient.min.js"></script>
		<script src="scripts/ocel/eventsView.js"></script>
		<script src="scripts/ocel/objectsView.js"></script>
		<script src="scripts/ocel/edgesView.js"></script>
		<script src="scripts/ocel/ocdfg-model.js"></script>
		<script src="scripts/ocel/ocdfg-visualization.js"></script>
		<script src="scripts/ocel/xmlocel-exporter.js"></script>
		<script src="scripts/ocel/xmlocel-importer.js"></script>
		<script src="scripts/ocel/jsonocel-exporter.js"></script>
		<script src="scripts/ocel/jsonocel-importer.js"></script>
		<script src="scripts/ocel/ocel-flattening.js"></script>
		<script src="scripts/generic/sorttable.js"></script>
		<script src="scripts/ocel/eventsList.js"></script>
		<script src="scripts/ocel/objectsList.js"></script>
		<script src="scripts/ocel/plotly-graphs.js"></script>
		<link rel="stylesheet" href="static/bootstrap.min.css"></link>
		<link rel="stylesheet" href="static/bootstrap-grid.min.css"></link>
		<link rel="stylesheet" href="static/bootstrap-reboot.min.css"></link>
		<link rel="stylesheet" href="static/navx-navigation.min.css"></link>
		<link rel="stylesheet" href="static/navx-styles.min.css"></link>
		<link rel="stylesheet" href="static/fontawesome-all.min.css"></link>
	</head>
	<body>
		<script type="text/javascript">
			let selectedActivity = null;
			let selectedOt = null;
			let selectedEdge = null;
			let visualization = null;
			//let eventLog = null;
		</script>
		<div id="uploadPart" style="display: ">
			<img src="static/pads_rwth.png" /><br />
			<h3>OC-DFG visualization</h3>
			Welcome! Please upload an object-centric event log in the OCEL-XML and/or the OCEL-JSON formats.
			<div id="initial_upload" style="display: ">
				<input type="file" id="upload" />
			</div>
		</div>
		<div id="mainApplication" style="display: none" class="container-fluid">
			<div id="header" style="background-color:">
				<nav id="navigationHeader" class="navigation navigation-justified">
					<div class="navigation-header">

					</div>
					<div class="navigation-body">		
						<ul class="navigation-menu">

							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showProcessModelPage()"><i class="fas fa-project-diagram"></i>&nbsp;Process Schema</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showEventsList()"><i class="fas fa-atom"></i>Events</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showObjectsList()"><i class="fas fa-database"></i>&nbsp;Objects</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="javascript:showGraphs()"><i class="fas fa-chart-pie"></i>&nbsp;Statistics</a>
							</li>
							
							<li class="navigation-item">
								<a class="navigation-link" href="#"><i class="fas fa-filter"></i>&nbsp;Filters</a>
								<div class="navigation-megamenu">
									<div class="navigation-megamenu-container">
										<div class="navigation-row">
											<button id="reset_filters" onclick="resetFilters()">Reset Filters</button>
										</div>
									</div>
								</div>
							</li>
						
							<li class="navigation-item">
								<a class="navigation-link" href="#"><i class="fas fa-download"></i>&nbsp;Download Log</a>
								<div class="navigation-megamenu">
									<div class="navigation-megamenu-container">
										<div class="navigation-row">
											<div><button id="downloadJsonOcel" onclick="downloadJsonOcel()">Download JSON Ocel</button></div>
											<div><button id="downloadXmlOcel" onclick="downloadXmlOcel()">Download XML Ocel</button></div>
											<div>
												Flattening OT: <select id="flatteningOt">
												</select>
												<button id="flattenEventLog" onclick="flattenEventLog()">Flatten (XES)</button>
											</div>
										</div>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</nav>
			</div>
			<div id="processModelPage" style="display:; overflow: hidden">
				<div class="row mh-75 flex-fill">
					<div class="col-2">
						<div>N. Events:</div>
						<div id="numEvents">0</div>
						<div>N. Uniq. Objects:</div>
						<div id="numUniqObjects">0</div>
						<div>N. Total Objects:</div>
						<div id="numTotalObjects">0</div>
						<div>% act.:</div>
						<div><input id="af_slider" type="range" min="0" max="100" value="70" class="slider"></div>
						<div>% paths:</div>
						<div><input id="pf_slider" type="range" min="0" max="100" value="70" class="slider"></div>
						<div><button id="apply_changes" onclick="doVisualization()">Apply Changes</button></div>
					</div>
					<div class="col-10">
						<div id="graphContainerHeader">
							<nav id="navigationGraph" class="navigation navigation-justified">
								<div class="navigation-header">

								</div>
								<div class="navigation-body">		
									<ul class="navigation-menu">

										<li class="navigation-item">
											<a class="navigation-link" href="#"><i class="fas fa-cog"></i>&nbsp;Options</a>
											<div class="navigation-megamenu">
												<div class="navigation-megamenu-container">
													<div class="navigation-row">
														<div>Visualization:
														<select id="visualizationType">
															<option value="dfg" selected>DFG</option>
															<option value="petriNet">Petri Net</option>
														</select></div>
														<div>Annotation:
														<select id="annotationSelector">
															<option id="events" value="0">Events</option>
															<option id="unique_objects" value="1" selected>Unique Objects</option>
															<option id="total_objects" value="2">Total Objects</option>
														</select></div>
														<div><button id="apply_changes2" onclick="doVisualization()">Apply Changes</button></div>
													</div>
												</div>
											</div>
										</li>
									
										<li class="navigation-item">
											<a class="navigation-link" href="#"><i class="fab fa-superpowers"></i>Object Types</a>
											<div class="navigation-megamenu">
												<div class="navigation-megamenu-container">
													<div class="navigation-row">
														<div>
														Select the object types: <select id="objectTypes" multiple style="height: 40px">
														</select></div>
														<div>
														<button id="filterObjectTypes" onclick="filterObjectTypes()">Filter on Obj Types</button></div>
														<div></div>
													</div>
												</div>
											</div>
										</li>
										
										
									</ul>
								</div>
							</nav>
						</div>
						<div id="graphContainer"></div>
					</div>
				</div>
				<script type="text/javascript">
					var navigationGraph = null;
					
					function doVisualization() {
						let af = document.getElementById("af_slider").value / 100.0;
						let pf = document.getElementById("pf_slider").value / 100.0;
						let annotation = parseInt(document.getElementById("annotationSelector").value);
						visualization.ACTIVITY_FREQUENCY = af;
						visualization.PATHS_FREQUENCY = pf;
						visualization.IDX = annotation;
						visualization.displayType = document.getElementById("visualizationType").value;
						visualization.represent();
						if (navigationGraph == null) {
							navigationGraph = new Navigation(document.getElementById("navigationGraph"));
						}
					}
					
					function resetFilters() {
						visualization.resetFilters();
						doVisualization();
					}
					
					function downloadJsonOcel() {
						let jsonStri = JsonOcelExporter.exportLog(visualization.model.ocel);
						download(jsonStri, "obj-centr-log.jsonocel", "text/json");
					}
					
					function downloadXmlOcel() {
						let xmlStri = XmlOcelExporter.exportLog(visualization.model.ocel);
						download(xmlStri, "obj-centr-log.xmlocel", "text/xml");
					}
					
					function flattenEventLog() {
						let ot = document.getElementById("flatteningOt").value;
						let eventLog = OcelFlattening.flatten(visualization.model.ocel, ot);
						let xmlStri = XesExporter.apply(eventLog);
						download(xmlStri, "flattened.xes", "text/xml");
					}
					
					function filterObjectTypes() {
						let selectedOptions = [];
						for (let option of document.getElementById("objectTypes").children) {
							if (option.selected) {
								selectedOptions.push(option.value);
							}
						}
						let filteredModel = visualization.model.filterObjectTypes(selectedOptions);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterRelatedObjectsActivity() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let filteredModel = visualization.model.filterRelatedObjects(relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonRelatedObjectsActivity() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !relObj.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function expandActivity() {
						visualization.doExpandActivity(selectedActivity);
						visualization.represent();
					}
					
					function filterNonStartingWith() {
						let startingWith = visualization.model.otObjectsView[selectedOt].getStartingWith(selectedActivity);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !startingWith.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, startingWith);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonEndingWith() {
						let endingWith = visualization.model.otObjectsView[selectedOt].getEndingWith(selectedActivity);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !endingWith.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, endingWith);
						visualization.setFilteredModel(filteredModel);
					}
					
					function seeRelatedObjAct() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						alert(relObj.toString());
					}
					
					function filterRelatedObjectsEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let filteredModel = visualization.model.filterRelatedObjects(relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonRelatedObjectsEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedEdge[2]].objectsIds);
						let difference = allObjOt.filter(x => !relObj.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function seeRelatedObjEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						alert(relObj.toString());
					}
					
					function callbackActivity(activity, ot) {
						selectedActivity = activity;
						selectedOt = ot;
					}
					
					function callbackEdge(edge) {
						selectedEdge = edge;
					}
					
					function callbackStatistics(events, uo, to) {
						document.getElementById("numEvents").innerHTML = events;
						document.getElementById("numUniqObjects").innerHTML = uo;
						document.getElementById("numTotalObjects").innerHTML = to;
					}
					
					function handleFileSelect(evt) {
						var files = evt.target.files; // FileList object
						// use the 1st file from the list
						f = files[0];
						var reader = new FileReader();
						reader.onload = function(e) {
							console.log(f);
							let contentStri = e.target.result;
							if (f.name.endsWith(".xmlocel")) {
								eventLog = XmlOcelImporter.importLog(contentStri);
								createVisualization();
							}
							else {
								eventLog = JsonOcelImporter.importLog(contentStri);
								createVisualization();
							}
						}
						reader.readAsText(f);
					}
					
					function createVisualization() {
						document.getElementById("mainApplication").style.display = "";
						document.getElementById("uploadPart").style.display = "none";
						visualization = new OcdfgVisualization(new OcdfgModel(eventLog), "graphContainer");
						visualization.callbackActivity = callbackActivity;
						visualization.callbackEdge = callbackEdge;
						visualization.callbackStatistics = callbackStatistics;
						visualization.populateStatistics();
						doVisualization();
					}
					
					document.getElementById('upload').addEventListener('change', handleFileSelect, false);
				</script>
			</div>
			<div id="eventsListPage" style="display: none">
				<p>The page shows the list of events of the log. Each event is distinguished by its fundamental properties (ID, activity and timestamp),
				a list of related objects for each type, and values for some attributes. Clicking an object, it is possible to see the lifecycle
				of the object.</p>
				<table id="eventsListTable" border="1">
				</table>
			</div>
			<div id="objectsListPage" style="display: none">
				<p>The page shows the properties of the objects, after the selection of an object type. Each object is distinguished by the timestamp of the first
				event of its lifecycle, the timestamp of the last event of its lifecycle, and the difference between them.</p>
				<p>To start, please select an object type:
				<select id="otObjListSelection">
				</select>
				<button id="showObjListOt" onclick="showObjListOt()">Show the list of Objects</button>
				</p>
				<table id="objectsListTable" border="1">
				</table>
			</div>
			<div id="plotlyGraphsPage" style="display: none">
				<div id="plotlyOtGraph">
					
				</div>
				<div id="plotlyActGraph">
					
				</div>
			</div>
			<div class="hover_bkgr_fricc">
				<span class="helper"></span>
				<div>
					<div class="popupCloseButton">&times;</div>
					<h4><b>Lifecycle of the Object:</b> <span id="popupObjId"></h4>
					<div style="width: 100%; height: 85%; overflow: scroll">
						<table id="customEventsListTable" border="1">
						</table>
					</div>
				</div>
			</div>
		</div>
		<script src="logs/example-jsonocel.js"></script>
		<script type="text/javascript">
			function hideAllDivsPages() {
				document.getElementById("processModelPage").style.display = "none";
				document.getElementById("eventsListPage").style.display = "none";
				document.getElementById("objectsListPage").style.display = "none";
				document.getElementById("plotlyGraphsPage").style.display = "none";
			}
			
			function showProcessModelPage() {
				hideAllDivsPages();
				document.getElementById("processModelPage").style.display = "";
			}
			
			function showEventsList() {
				hideAllDivsPages();
				document.getElementById("eventsListPage").style.display = "";
				eventsListFactory = new EventsListFactory(visualization.model);
				eventsListFactory.buildEventsTable(document.getElementById("eventsListTable"));
			}
			
			function showObjectsList() {
				hideAllDivsPages();
				document.getElementById("objectsListPage").style.display = "";
			}
			
			function showGraphs() {
				hideAllDivsPages();
				document.getElementById("plotlyGraphsPage").style.display = "";
				plotlyOcelGraphs = new PlotlyOcelGraphs(visualization.model);
				plotlyOcelGraphs.buildOtGraph();
				plotlyOcelGraphs.buildActivitiesGraph();
			}
			
			function clickedObjectInEveTable(obj) {
				let relTuples = visualization.model.overallObjectsView.objectsIdsSorted[obj];
				let relEvs = {};
				for (let tup of relTuples) {
					relEvs[tup[0]] = 0;
				}
				let eventsListFactory = new EventsListFactory(visualization.model);
				eventsListFactory.buildEventsTable(document.getElementById("customEventsListTable"), events=relEvs, enable_click=false, target_obj=obj);
				$('.hover_bkgr_fricc').show();
				document.getElementById("popupObjId").innerHTML = obj;
			}
			
			function showObjListOt() {
				let selectedOt = document.getElementById("otObjListSelection").value;
				objectsListFactory = new ObjectsListFactory(visualization.model);
				objectsListFactory.buildObjectsTable(document.getElementById("objectsListTable"), selectedOt);
			}

			$('.hover_bkgr_fricc').click(function(){
				$('.hover_bkgr_fricc').hide();
			});
			$('.popupCloseButton').click(function(){
				$('.hover_bkgr_fricc').hide();
			});
			
			createVisualization();
		</script>
		<script type="text/javascript">
			var navigationHeader = new Navigation(document.getElementById("navigationHeader"));
		</script>
	</body>
</html>