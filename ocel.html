<html>
	<head>
		<link rel="stylesheet" href="ocel.css">
		<script src="scripts/pm4js/eventLog.js"></script>
		<script src="scripts/generic/jquery.min.js"></script>
		<script src="scripts/generic/download-utility.js"></script>
		<script src="scripts/pm4js/xesParser.js"></script>
		<script src="scripts/pm4js/xesExporter.js"></script>
		<script src="scripts/pm4js/log-statistics.js"></script>
		<script src="scripts/pm4js/dfg.js"></script>
		<script src="scripts/generic/mxClient.min.js"></script>
		<script src="scripts/ocel/eventsView.js"></script>
		<script src="scripts/ocel/objectsView.js"></script>
		<script src="scripts/ocel/edgesView.js"></script>
		<script src="scripts/ocel/ocdfg-model.js"></script>
		<script src="scripts/ocel/ocdfg-visualization.js"></script>
		<script src="scripts/ocel/xmlocel-exporter.js"></script>
		<script src="scripts/ocel/xmlocel-importer.js"></script>
		<script src="scripts/ocel/jsonocel-exporter.js"></script>
		<script src="scripts/ocel/jsonocel-importer.js"></script>
		<script src="scripts/ocel/ocel-flattening.js"></script>
		<script src="scripts/generic/sorttable.js"></script>
		<script src="scripts/ocel/eventsList.js"></script>
		<script src="scripts/ocel/objectsList.js"></script>
	</head>
	<body>
		<script type="text/javascript">
			let selectedActivity = null;
			let selectedOt = null;
			let selectedEdge = null;
			let visualization = null;
			//let eventLog = null;
		</script>
		<div id="uploadPart" style="display: ">
			<img src="static/pads_rwth.png" /><br />
			<h3>OC-DFG visualization</h3>
			Welcome! Please upload an object-centric event log in the OCEL-XML and/or the OCEL-JSON formats.
			<div id="initial_upload" style="display: ">
				<input type="file" id="upload" />
			</div>
		</div>
		<div id="mainApplication" style="display: none">
			<div id="header">
				<button id="downloadJsonOcel" onclick="downloadJsonOcel()" style="background-color: red; color: white">Download JSON Ocel</button>
				<button id="downloadXmlOcel" onclick="downloadXmlOcel()" style="background-color: red; color: white">Download XML Ocel</button>
				Flattening OT: <select id="flatteningOt">
				</select>
				<button id="flattenEventLog" onclick="flattenEventLog()" style="background-color: red; color: white">Flatten (XES)</button>
				<br />
				N. Events: <span id="numEvents">0</span>
				N. Uniq. Objects: <span id="numUniqObjects">0</span>
				N. Total Objects: <span id="numTotalObjects">0</span>
				<button id="show_process_model" onclick="showProcessModelPage()" style="background-color: blue; color: white">Show Process Model</button>
				<button id="show_events_list" onclick="showEventsList()" style="background-color: blue; color: white">Show Events List</button>
				<button id="show_objects_list" onclick="showObjectsList()" style="background-color: blue; color: white">Show Objects List</button>
			</div>
			<div id="processModelPage" style="display: ">
				<div id="header2">
					Annotation:
					<select id="annotationSelector">
						<option id="events" value="0">Events</option>
						<option id="unique_objects" value="1" selected>Unique Objects</option>
						<option id="total_objects" value="2">Total Objects</option>
					</select>
					% act.: <input id="af_slider" type="range" min="0" max="100" value="70" class="slider">
					% paths: <input id="pf_slider" type="range" min="0" max="100" value="70" class="slider">
					<button id="apply_changes" onclick="doVisualization()">Apply Changes</button>
					<button id="reset_filters" onclick="resetFilters()">Reset Filters</button><br />
					Selected activity: <span id="selectedActivity"></span>
					<button id="filterRelatedObjectsActivity" onclick="filterRelatedObjectsActivity()" disabled>Filter Rel.Obj</button>
					<button id="filterNonRelatedObjectsActivity" onclick="filterNonRelatedObjectsActivity()" disabled>Filter Non Rel.Obj</button>
					<button id="filterNonStartingWith" onclick="filterNonStartingWith()" disabled>Filter Non Starting With</button>
					<button id="filterNonEndingWith" onclick="filterNonEndingWith()" disabled>Filter Non Ending With</button>
					<button id="seeRelatedObjAct" onclick="seeRelatedObjAct()" disabled>See Rel.Obj.</button><br />
					Selected edge: <span id="selectedEdge"></span>
					<button id="filterRelatedObjectsEdge" onclick="filterRelatedObjectsEdge()" disabled>Filter Rel.Obj</button>
					<button id="filterNonRelatedObjectsEdge" onclick="filterNonRelatedObjectsEdge()" disabled>Filter Non Rel.Obj</button>
					<button id="seeRelatedObjEdge" onclick="seeRelatedObjEdge()" disabled>See Rel.Obj. Edge</button>
					Select the object types: <select id="objectTypes" multiple style="height: 40px">
					</select>
					<button id="filterObjectTypes" onclick="filterObjectTypes()">Filter on Obj Types</button>
				</div>
				<div id="graphContainer">
				</div>
				<script type="text/javascript">			
					function doVisualization() {
						let af = document.getElementById("af_slider").value / 100.0;
						let pf = document.getElementById("pf_slider").value / 100.0;
						let annotation = parseInt(document.getElementById("annotationSelector").value);
						visualization.ACTIVITY_FREQUENCY = af;
						visualization.PATHS_FREQUENCY = pf;
						visualization.IDX = annotation;
						visualization.represent();
					}
					
					function resetFilters() {
						visualization.resetFilters();
						doVisualization();
					}
					
					function downloadJsonOcel() {
						let jsonStri = JsonOcelExporter.exportLog(visualization.model.ocel);
						download(jsonStri, "obj-centr-log.jsonocel", "text/json");
					}
					
					function downloadXmlOcel() {
						let xmlStri = XmlOcelExporter.exportLog(visualization.model.ocel);
						download(xmlStri, "obj-centr-log.xmlocel", "text/xml");
					}
					
					function flattenEventLog() {
						let ot = document.getElementById("flatteningOt").value;
						let eventLog = OcelFlattening.flatten(visualization.model.ocel, ot);
						let xmlStri = XesExporter.exportLog(eventLog);
						download(xmlStri, "flattened.xes", "text/xml");
					}
					
					function filterObjectTypes() {
						let selectedOptions = [];
						for (let option of document.getElementById("objectTypes").children) {
							if (option.selected) {
								selectedOptions.push(option.value);
							}
						}
						let filteredModel = visualization.model.filterObjectTypes(selectedOptions);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterRelatedObjectsActivity() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let filteredModel = visualization.model.filterRelatedObjects(relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonRelatedObjectsActivity() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !relObj.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonStartingWith() {
						let startingWith = visualization.model.otObjectsView[selectedOt].getStartingWith(selectedActivity);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !startingWith.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, startingWith);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonEndingWith() {
						let endingWith = visualization.model.otObjectsView[selectedOt].getEndingWith(selectedActivity);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedOt].objectsIds);
						let difference = allObjOt.filter(x => !endingWith.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, endingWith);
						visualization.setFilteredModel(filteredModel);
					}
					
					function seeRelatedObjAct() {
						let relObj = visualization.model.getRelObjActivity(selectedActivity, selectedOt);
						alert(relObj.toString());
					}
					
					function filterRelatedObjectsEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let filteredModel = visualization.model.filterRelatedObjects(relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function filterNonRelatedObjectsEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						let allObjOt = Object.keys(visualization.model.otObjectsView[selectedEdge[2]].objectsIds);
						let difference = allObjOt.filter(x => !relObj.includes(x));
						let filteredModel = visualization.model.filterNonRelatedObjects(difference, relObj);
						visualization.setFilteredModel(filteredModel);
					}
					
					function seeRelatedObjEdge() {
						let relObj = visualization.model.getRelObjEdge([selectedEdge[0], selectedEdge[1]], selectedEdge[2]);
						alert(relObj.toString());
					}
					
					function callbackActivity(activity, ot) {
						selectedActivity = activity;
						selectedOt = ot;
						if (selectedActivity != null) {
							document.getElementById("filterRelatedObjectsActivity").disabled = false;
							document.getElementById("seeRelatedObjAct").disabled = false;
							if (selectedOt != null) {
								document.getElementById("selectedActivity").innerHTML = selectedActivity+" ("+selectedOt+")";
								document.getElementById("filterNonRelatedObjectsActivity").disabled = false;
								document.getElementById("filterNonStartingWith").disabled = false;
								document.getElementById("filterNonEndingWith").disabled = false;
							}
							else {
								document.getElementById("selectedActivity").innerHTML = selectedActivity;
								document.getElementById("filterNonRelatedObjectsActivity").disabled = true;
								document.getElementById("filterNonStartingWith").disabled = true;
								document.getElementById("filterNonEndingWith").disabled = true;
							}
						}
					}
					
					function callbackEdge(edge) {
						selectedEdge = edge;
						document.getElementById("selectedEdge").innerHTML = selectedEdge.toString();
						document.getElementById("filterRelatedObjectsEdge").disabled = false;
						document.getElementById("filterNonRelatedObjectsEdge").disabled = false;
						document.getElementById("seeRelatedObjEdge").disabled = false;
					}
					
					function callbackStatistics(events, uo, to) {
						document.getElementById("numEvents").innerHTML = events;
						document.getElementById("numUniqObjects").innerHTML = uo;
						document.getElementById("numTotalObjects").innerHTML = to;
					}
					
					function handleFileSelect(evt) {
						var files = evt.target.files; // FileList object
						// use the 1st file from the list
						f = files[0];
						var reader = new FileReader();
						reader.onload = function(e) {
							console.log(f);
							let contentStri = e.target.result;
							if (f.name.endsWith(".xmlocel")) {
								eventLog = XmlOcelImporter.importLog(contentStri);
								createVisualization();
							}
							else {
								eventLog = JsonOcelImporter.importLog(contentStri);
								createVisualization();
							}
						}
						reader.readAsText(f);
					}
					
					function createVisualization() {
						document.getElementById("mainApplication").style.display = "";
						document.getElementById("uploadPart").style.display = "none";
						visualization = new OcdfgVisualization(new OcdfgModel(eventLog), "graphContainer");
						visualization.callbackActivity = callbackActivity;
						visualization.callbackEdge = callbackEdge;
						visualization.callbackStatistics = callbackStatistics;
						visualization.populateStatistics();
						doVisualization();
					}
					
					document.getElementById('upload').addEventListener('change', handleFileSelect, false);
				</script>
			</div>
			<div id="eventsListPage" style="display: none">
				<p>The page shows the list of events of the log. Each event is distinguished by its fundamental properties (ID, activity and timestamp),
				a list of related objects for each type, and values for some attributes. Clicking an object, it is possible to see the lifecycle
				of the object.</p>
				<div class="hover_bkgr_fricc">
					<span class="helper"></span>
					<div>
						<div class="popupCloseButton">&times;</div>
						<h4><b>Lifecycle of the Object:</b> <span id="popupObjId"></h4>
						<div style="width: 100%; height: 85%; overflow: scroll">
							<table id="customEventsListTable" border="1">
							</table>
						</div>
					</div>
				</div>
				<table id="eventsListTable" border="1">
				</table>
			</div>
			<div id="objectsListPage" style="display: none">
				<table id="objectsListTable" border="1">
				</table>
			</div>
		</div>
		<script src="logs/example-jsonocel.js"></script>
		<script type="text/javascript">
			function hideAllDivsPages() {
				document.getElementById("processModelPage").style.display = "none";
				document.getElementById("eventsListPage").style.display = "none";
				document.getElementById("objectsListPage").style.display = "none";
			}
			
			function showProcessModelPage() {
				hideAllDivsPages();
				document.getElementById("processModelPage").style.display = "";
			}
			
			function showEventsList() {
				hideAllDivsPages();
				document.getElementById("eventsListPage").style.display = "";
				eventsListFactory = new EventsListFactory(visualization.model);
				eventsListFactory.buildEventsTable(document.getElementById("eventsListTable"));
			}
			
			function showObjectsList() {
				hideAllDivsPages();
				document.getElementById("objectsListPage").style.display = "";
				objectsListFactory = new ObjectsListFactory(visualization.model);
				objectsListFactory.buildObjectsTable(document.getElementById("objectsListTable"));
			}
			
			function clickedObjectInEveTable(obj) {
				let relTuples = visualization.model.overallObjectsView.objectsIdsSorted[obj];
				let relEvs = {};
				for (let tup of relTuples) {
					relEvs[tup[0]] = 0;
				}
				let eventsListFactory = new EventsListFactory(visualization.model);
				eventsListFactory.buildEventsTable(document.getElementById("customEventsListTable"), events=relEvs, enable_click=false, target_obj=obj);
				$('.hover_bkgr_fricc').show();
				document.getElementById("popupObjId").innerHTML = obj;
			}
			
			/*$(".trigger_popup_fricc").click(function(){
			   $('.hover_bkgr_fricc').show();
			});*/
			$('.hover_bkgr_fricc').click(function(){
				$('.hover_bkgr_fricc').hide();
			});
			$('.popupCloseButton').click(function(){
				$('.hover_bkgr_fricc').hide();
			});
			
			createVisualization();
		</script>
	</body>
</html>