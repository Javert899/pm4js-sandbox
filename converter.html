<html>
	<head>
		<script src="scripts/generic/jquery.min.js"></script>
		<script src="scripts/generic/download-utility.js"></script>
		<script src="scripts/pm4js_latest.js"></script>
		<script src="scripts/ocel/xmlocel-exporter.js"></script>
		<script src="scripts/ocel/xmlocel-importer.js"></script>
		<script src="scripts/ocel/jsonocel-exporter.js"></script>
		<script src="scripts/ocel/jsonocel-importer.js"></script>
		<script src="scripts/ocel/ocel-flattening.js"></script>
	</head>
	<body>
		<img src="static/pads_rwth.png" /><br />
		<p>The goal of this prototypal application is:</p>
		<ul>
			<li>To be able to ingest a JSON-OCEL / XML-OCEL event log.</li>
			<li>To be able to export the log as JSON-OCEL / XML-OCEL, or to flatten it to an object type</li>
		</ul>
		<div id="initial_upload" style="display: ">
			<input type="file" id="upload" />
		</div>
		<div id="after_upload" style="display: none">
			<button onclick="javascript:downloadAsJSONOcel()">Download as JSON-OCEL</button><br />
			<button onclick="javascript:downloadAsXMLOcel()">Download as XML-OCEL</button><br />
			Select an object type:
			<select id="objectTypeSelection" name="objectTypeSelection">
			</select>
			<button onclick="javascript:flattenToXES()">Flatten to XES</button><br />
		</div>
		<script type="text/javascript">
			let ocel = null;
			function handleFileSelect(evt) {
				var files = evt.target.files; // FileList object
				// use the 1st file from the list
				f = files[0];
				var reader = new FileReader();
				reader.onload = function(e) {
					console.log(f);
					let contentStri = e.target.result;
					if (f.name.endsWith(".xmlocel")) {
						ocel = XmlOcelImporter.importLog(contentStri);
						populateObjectTypes();
						changeVisibility();
					}
					else {
						ocel = JsonOcelImporter.importLog(contentStri);
						populateObjectTypes();
						changeVisibility();
					}
				}
				reader.readAsText(f);
			}
			
			function changeVisibility() {
				document.getElementById("initial_upload").style.display = "none";
				document.getElementById("after_upload").style.display = "";
			}
			
			function downloadAsJSONOcel() {
				let jsonString = JsonOcelExporter.exportLog(ocel);
				download(jsonString, "log.jsonocel", "text/json");
			}
			
			function downloadAsXMLOcel() {
				let xmlString = XmlOcelExporter.exportLog(ocel);
				download(xmlString, "log.xmlocel", "text/json");
			}
			
			function flattenToXES() {
				let value = document.getElementById("objectTypeSelection").value;
				let log = OcelFlattening.flatten(ocel, value);
				console.log(log);
				let xmlString = XesExporter.apply(log);
				download(xmlString, "flattened.xes", "text/xml");
			}
			
			function populateObjectTypes() {
				for (let objType of ocel["ocel:global-log"]["ocel:object-types"]) {
					let option = document.createElement("option");
					option.setAttribute("value", objType);
					option.text = objType;
					document.getElementById("objectTypeSelection").appendChild(option);
				}
			}
			
			document.getElementById('upload').addEventListener('change', handleFileSelect, false);
		</script>
	</body>
</html>
